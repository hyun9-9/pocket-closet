// Prisma Schema for Pocket Closet
// ì£¼ë¨¸ë‹ˆ ì† ì˜·ì¥ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// ì‚¬ìš©ì ê´€ë ¨
// ================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ì²´í˜• ì •ë³´
  bodyInfo BodyInfo?

  // ìŠ¤íƒ€ì¼ ì„ í˜¸ë„
  stylePreferences StylePreference?

  // ë‚´ ì˜·ë“¤
  clothes MyClothing[]

  // ìŠ¤íƒ€ì¼ ì¡°í•©
  combinations StyleCombination[]

  // ì‚¬ìš© í†µê³„
  usageStats UserUsageStats?

  @@map("users")
}

model BodyInfo {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ê¸°ë³¸ ì²´í˜•
  height         Int // cm
  weight         Int? // kg
  chest          Int? // ê°€ìŠ´ë‘˜ë ˆ cm
  waist          Int // í—ˆë¦¬ë‘˜ë ˆ cm
  hip            Int? // ì—‰ë©ì´ë‘˜ë ˆ cm
  shoulderWidth  Int? // ì–´ê¹¨ë„ˆë¹„ cm
  armLength      Int? // íŒ”ê¸¸ì´ cm
  legLength      Int? // ë‹¤ë¦¬ê¸¸ì´ cm
  neckCircumference Int? // ëª©ë‘˜ë ˆ cm

  // ìƒì˜ ì‚¬ì´ì¦ˆ (ì¼ë°˜ì ìœ¼ë¡œ ì…ëŠ” ì‚¬ì´ì¦ˆ)
  topSize    String? // XS, S, M, L, XL, XXL
  bottomSize String? // 28, 29, 30, 31...
  shoeSize   Int? // 250, 255, 260...

  // ì²´í˜• íƒ€ì…
  bodyType String? // ì‚¼ê°í˜•, ì—­ì‚¼ê°í˜•, ì§ì‚¬ê°í˜•, ëª¨ë˜ì‹œê³„

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("body_info")
}

model StylePreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ì„ í˜¸ ìŠ¤íƒ€ì¼ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥, JSON ë°°ì—´)
  preferredStyles String[] // ["ìºì£¼ì–¼", "ë¯¸ë‹ˆë©€", "ìŠ¤íŠ¸ë¦¿"]

  // ì„ í˜¸ ìƒ‰ìƒ
  preferredColors String[] // ["ë¸”ë™", "í™”ì´íŠ¸", "ë„¤ì´ë¹„"]

  // ì„ í˜¸ ë¸Œëœë“œ
  preferredBrands String[]

  // í”¼í•˜ëŠ” ìŠ¤íƒ€ì¼
  avoidedStyles String[]

  // ì£¼ìš” í™œë™/ìƒí™©
  mainActivities String[] // ["ì¶œê·¼", "ë°ì´íŠ¸", "ìš´ë™"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("style_preferences")
}

// ================================
// ì˜· ì¹´í…Œê³ ë¦¬
// ================================

model ClothingCategory {
  id          String @id @default(uuid())
  name        String @unique // "ìƒì˜", "í•˜ì˜", "ì•„ìš°í„°", "ì›í”¼ìŠ¤", "ì‹ ë°œ", "ì•¡ì„¸ì„œë¦¬"
  nameEn      String @unique // "top", "bottom", "outer", "dress", "shoes", "accessory"
  description String?

  // í•„ìˆ˜ ì¹˜ìˆ˜ ì •ë³´ (JSON)
  requiredMeasurements Json // { "chest": true, "length": true, "shoulder": false }

  clothes MyClothing[]

  @@map("clothing_categories")
}

// ================================
// ë‚´ ì˜·ì¥ (í•µì‹¬!)
// ================================

model MyClothing {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId String
  category   ClothingCategory @relation(fields: [categoryId], references: [id])

  // ========== ê¸°ë³¸ ì •ë³´ ==========
  name       String // ì‚¬ìš©ìê°€ ì§€ì€ ì´ë¦„ "ë¸”ë™ í›„ë“œí‹°"
  brand      String? // ë¸Œëœë“œëª…
  purchaseDate DateTime? // êµ¬ë§¤ì¼
  purchasePrice Int? // êµ¬ë§¤ê°€ê²©
  purchaseUrl String? // êµ¬ë§¤ì²˜ URL

  // ========== ì´ë¯¸ì§€ (í•µì‹¬!) ==========
  // ëª¨ë“  ì´ë¯¸ì§€ëŠ” URL (Supabase Storage ë˜ëŠ” Cloudinary)
  originalImage    String // ì›ë³¸ ì‚¬ì§„
  processedImage   String? // ë°°ê²½ ì œê±°ëœ ì´ë¯¸ì§€
  frontViewImage   String? // ì •ë©´ ì´ë¯¸ì§€ (Gemini ìƒì„±)
  sideViewImage    String? // ì¸¡ë©´ ì´ë¯¸ì§€
  backViewImage    String? // í›„ë©´ ì´ë¯¸ì§€
  thumbnailImage   String? // ì¸ë„¤ì¼ (128x128)

  // ========== AI ì¶”ì¶œ ë©”íƒ€ë°ì´í„° (ì´ˆìƒì„¸!) ==========
  
  // 1. ë¹„ì£¼ì–¼ ì†ì„±
  primaryColor   String // ì£¼ìš” ìƒ‰ìƒ "ë¸”ë™", HEX: "#000000"
  secondaryColor String? // ë³´ì¡° ìƒ‰ìƒ
  colorHex       String // HEX ì½”ë“œ
  pattern        String // "ë¬´ì§€", "ìŠ¤íŠ¸ë¼ì´í”„", "ì²´í¬", "ë„íŠ¸", "í”Œë¡œëŸ´"
  texture        String? // "ë¶€ë“œëŸ¬ì›€", "ê±°ì¹¨", "ê´‘íƒ", "ë§¤íŠ¸"
  silhouette     String? // "ìŠ¬ë¦¼í•", "ë ˆê·¤ëŸ¬í•", "ì˜¤ë²„í•", "ë£¨ì¦ˆí•"
  details        String[] // ["í›„ë“œ", "ì§€í¼", "í¬ì¼“"]

  // 2. ì¬ì§ˆ ì •ë³´
  material       String // "ì½”íŠ¼", "í´ë¦¬ì—ìŠ¤í„°", "ë°ë‹˜", "ë‹ˆíŠ¸", "ì‹¤í¬"
  materialWeight String? // "ë‘êº¼ì›€", "ë³´í†µ", "ì–‡ìŒ"
  stretch        String? // "ì‹ ì¶•ì„± ë†’ìŒ", "ë³´í†µ", "ì—†ìŒ"
  transparency   String? // "ë¶ˆíˆ¬ëª…", "ì•½ê°„ ë¹„ì¹¨", "ë¹„ì¹¨"
  formality      Int // ê²©ì‹ë„ 1-10 (1=ìš´ë™ë³µ, 10=ì •ì¥)

  // 3. ìŠ¤íƒ€ì¼ ì†ì„±
  style          String[] // ["ìºì£¼ì–¼", "ìŠ¤íŠ¸ë¦¿", "ë¯¸ë‹ˆë©€"]
  mood           String[] // ["í¸ì•ˆí•œ", "ì„¸ë ¨ëœ", "ìœ ë‹ˆí¬í•œ"]
  season         String[] // ["ë´„", "ì—¬ë¦„", "ê°€ì„", "ê²¨ìš¸", "ì‚¬ê³„ì ˆ"]
  occasion       String[] // ["ì¼ìƒ", "ì¶œê·¼", "ë°ì´íŠ¸", "ìš´ë™", "íŒŒí‹°"]

  // 4. ì¡°í•© ê·œì¹™ (JSON - AIê°€ ìƒì„±)
  matchingRules  Json
  // {
  //   "goodWith": {
  //     "colors": ["í™”ì´íŠ¸", "ê·¸ë ˆì´", "ë² ì´ì§€"],
  //     "patterns": ["ë¬´ì§€", "ìŠ¤íŠ¸ë¼ì´í”„"],
  //     "styles": ["ìºì£¼ì–¼", "ë¯¸ë‹ˆë©€"]
  //   },
  //   "avoidWith": {
  //     "colors": ["ë¸Œë¼ìš´"],
  //     "patterns": ["ì²´í¬"],
  //     "styles": []
  //   }
  // }

  // ========== ì¹˜ìˆ˜ ì •ë³´ ==========
  measurements   Json
  // ìƒì˜: { chest: 100, length: 70, shoulder: 45, sleeve: 60 }
  // í•˜ì˜: { waist: 80, hip: 95, length: 100, thigh: 60 }
  // ì‹ ë°œ: { size: 260, width: "ë³´í†µ" }

  // ========== ì‚¬ìš© í†µê³„ ==========
  wearCount      Int @default(0) // ì°©ìš© íšŸìˆ˜
  lastWornDate   DateTime? // ë§ˆì§€ë§‰ ì°©ìš©ì¼
  rating         Float? // ì‚¬ìš©ì í‰ì  1-5
  tags           String[] // ì‚¬ìš©ì íƒœê·¸ ["ì¦ê²¨ì°¾ê¸°", "ì—¬ë¦„", "ì¶œê·¼ë£©"]

  // ë©”íƒ€
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ê´€ê³„
  combinationItems CombinationItem[]
  pairings1        ClothingPair[] @relation("clothing1")
  pairings2        ClothingPair[] @relation("clothing2")

  @@index([userId, categoryId])
  @@map("my_clothes")
}

// ================================
// ìŠ¤íƒ€ì¼ ì¡°í•©
// ================================

model StyleCombination {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String // "ë°ì´íŠ¸ ë£© #1"
  description String? // "ë¡œë§¨í‹±í•˜ê³  í¸ì•ˆí•œ ë´„ ë°ì´íŠ¸ ì½”ë””"
  occasion    String // "ë°ì´íŠ¸", "ì¶œê·¼", "ìš´ë™"
  season      String? // "ë´„", "ì—¬ë¦„"

  // ì‹œê°í™” ì´ë¯¸ì§€ (Geminiê°€ ìƒì„±í•œ í•©ì„± ì´ë¯¸ì§€)
  visualizationImage String?

  // AI ì¶”ì²œ ì—¬ë¶€
  isAiRecommended Boolean @default(false)

  // ğŸ”¥ ì¶”ê°€: ì €ì¥ ì •ë³´
  savedAt     DateTime? // ì €ì¥í•œ ì‹œê°„ (nullì´ë©´ ì•„ì§ ì„ì‹œ)
  originalRecommendationRank Int? // ì›ë˜ ì¶”ì²œ ìˆœìœ„ (1,2,3,4,5 ë“±)

  // í‰ì  & í”¼ë“œë°±
  rating      Float? // 1-5
  feedback    String? // ì‚¬ìš©ì í”¼ë“œë°±

  // ì‚¬ìš© í†µê³„
  usedCount   Int @default(0)
  lastUsedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ì´ ì¡°í•©ì— í¬í•¨ëœ ì˜·ë“¤
  items       CombinationItem[]

  @@index([userId])
  @@index([userId, isAiRecommended])
  @@index([userId, savedAt])
  @@map("style_combinations")
}

model CombinationItem {
  id            String           @id @default(uuid())
  combinationId String
  combination   StyleCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  clothingId    String
  clothing      MyClothing       @relation(fields: [clothingId], references: [id], onDelete: Cascade)

  layer         Int // ë ˆì´ì–´ ìˆœì„œ (1=ì†ì˜·, 2=ì…”ì¸ , 3=ì•„ìš°í„°)

  @@unique([combinationId, clothingId])
  @@map("combination_items")
}

// ================================
// ì˜· ê¶í•© í†µê³„ (í•™ìŠµìš©)
// ================================

model ClothingPair {
  id         String @id @default(uuid())
  
  clothing1Id String
  clothing1   MyClothing @relation("clothing1", fields: [clothing1Id], references: [id], onDelete: Cascade)
  
  clothing2Id String
  clothing2   MyClothing @relation("clothing2", fields: [clothing2Id], references: [id], onDelete: Cascade)

  // í†µê³„
  usedTogether Int @default(1) // í•¨ê»˜ ì‚¬ìš©ëœ íšŸìˆ˜
  avgRating    Float? // í‰ê·  í‰ì 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clothing1Id, clothing2Id])
  @@index([clothing1Id])
  @@index([clothing2Id])
  @@map("clothing_pairs")
}

// ================================
// ì‚¬ìš©ì í™œë™ í†µê³„
// ================================

model UserUsageStats {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // API ì‚¬ìš©ëŸ‰
  totalApiCalls      Int @default(0)
  monthlyApiCalls    Int @default(0)
  lastMonthReset     DateTime @default(now())

  // ê¸°ëŠ¥ë³„ ì‚¬ìš©
  clothingRegistrations Int @default(0) // ì˜· ë“±ë¡ íšŸìˆ˜
  aiRecommendations     Int @default(0) // AI ì¶”ì²œ ì‚¬ìš©
  avatarFittings        Int @default(0) // ì•„ë°”íƒ€ í”¼íŒ…
  realTimeEdits         Int @default(0) // ì‹¤ì‹œê°„ í¸ì§‘

  // ì´ ë¹„ìš© (ì¶”ì ìš©)
  totalCostUSD       Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_usage_stats")
}

// ================================
// ìºì‹± (ì„ íƒì , Redis ëŒ€ì‹  DB ì‚¬ìš© ì‹œ)
// ================================

model CacheEntry {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("cache_entries")
}